# Dockerfile.ui
# ── ステージ１：依存解決＆UIビルド ──
FROM node:18-alpine AS builder
WORKDIR /repo

# pnpm と shx をグローバルインストール
RUN npm install -g pnpm@9.12.3 shx

# モノレポ定義＆ソースを丸ごとコピー
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY packages ./packages
COPY apps     ./apps

# 依存をインストール（prepare スクリプトも動き、dist が生成される）
RUN pnpm install

# apps/agent-tars だけビルドして dist/web 等を生成
RUN pnpm --filter ./apps/agent-tars run build:web

# ── ステージ２：軽量ランタイム ──
FROM node:18-alpine AS runner
WORKDIR /app

# pnpm をグローバルインストール
RUN npm install -g pnpm@9.12.3

# ワークスペース定義とロックファイルをコピー
COPY --from=builder /repo/pnpm-workspace.yaml ./
COPY --from=builder /repo/package.json         ./
COPY --from=builder /repo/pnpm-lock.yaml        ./

# モノレポ全体ソースをコピー（workspace:* 依存解決のため）
COPY --from=builder /repo/packages ./packages
COPY --from=builder /repo/apps     ./apps

# 本番依存だけインストール（workspace:* も解決）
RUN pnpm install --prod --no-frozen-lockfile

# アプリディレクトリに移動して起動
WORKDIR /app/apps/agent-tars
CMD ["pnpm", "run", "start:web"]
