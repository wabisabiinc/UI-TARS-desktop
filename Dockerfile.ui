# ① ベースイメージは Node 20
FROM node:20.13.1-alpine AS runner
WORKDIR /app

# ② pnpm をグローバルインストール
RUN npm install -g pnpm@9.12.3

# ③ モノレポのルート設定だけコピー
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./

# ④ workspace:^ を解決可能にするため packages フォルダをまるごとコピー
COPY packages ./packages

# ⑤ UI アプリ本体の package.json と、CI で事前ビルドした dist をコピー
COPY apps/agent-tars/package.json    ./apps/agent-tars/
COPY apps/agent-tars/dist            ./apps/agent-tars/dist

# ⑥ UI アプリフォルダに移動
WORKDIR /app/apps/agent-tars

# ⑦ 本番依存だけインストール／フックスクリプトは無視
RUN echo "ignore-scripts=true" > .npmrc \
 && pnpm install --prod --no-frozen-lockfile \
 && rm .npmrc

# ⑧ 起動コマンド
CMD ["pnpm", "run", "start:web"]
