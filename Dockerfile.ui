# Dockerfile.ui
# ＝＝＝ ステージ1：ビルドステージ ＝＝＝
FROM node:20.13.1-alpine AS builder
WORKDIR /repo

# pnpm をグローバルに
RUN npm install -g pnpm@9.12.3

# モノレポ全体の定義とソースをコピー
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY packages ./packages
COPY apps     ./apps

# 依存解決して
RUN pnpm install

# apps/agent-tars だけビルドして dist を生成
RUN pnpm --filter ./apps/agent-tars run build:web

# ＝＝＝ ステージ2：ランタイムステージ ＝＝＝
FROM node:18-alpine AS runner
WORKDIR /app

# pnpm をグローバルに
RUN npm install -g pnpm@9.12.3

# ワークスペース定義とロックファイルをまるっとコピー
COPY --from=builder /repo/pnpm-workspace.yaml ./
COPY --from=builder /repo/package.json         ./
COPY --from=builder /repo/pnpm-lock.yaml        ./

# パッケージ群とアプリソースをコピー
COPY --from=builder /repo/packages ./packages
COPY --from=builder /repo/apps     ./apps

# すでにビルド済み dist をそのまま取り込む
# （apps/agent-tars/dist が builder で作られている）
# ↓ dist は apps/agent-tars/dist に入っている前提
#    ここでは“コピーのみ”なので実行しない
# （COPY apps をしているので dist フォルダも含まれています）

# 本番依存だけインストール（workspace:* も解決可）
RUN pnpm install --prod --no-frozen-lockfile

# 最後にアプリを起動
WORKDIR /app/apps/agent-tars
CMD ["pnpm", "run", "start:web"]
